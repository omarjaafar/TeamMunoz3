{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <h2>{{ template_data.title|default:"Email Thread" }}</h2>
  <hr>

  {% if messages_list %}
    <div class="card">
      <div class="card-body">
        {% for msg in messages_list %}
          <div style="margin-left: {{ msg.depth|default:0 }}rem; padding: .5rem; border-left: 2px solid #eee;">
            <div class="d-flex justify-content-between">
              <strong>
                {% if msg.sender %}
                  {{ msg.sender.username }} &lt;{{ msg.sender.email }}&gt;
                {% elif msg.sender_email %}
                  {{ msg.sender_email }}
                {% else %}
                  Unknown
                {% endif %}
              </strong>
              <small class="text-muted">{{ msg.timestamp|date:"M d, Y H:i" }}</small>
            </div>
            <div class="mb-2"><em>{{ msg.subject }}</em></div>
            <div class="mb-3">{{ msg.body|linebreaks }}</div>
          </div>
        {% endfor %}
      </div>
    </div>

    <hr>
    <h4>Reply</h4>
    <form method="post" action="{% url 'messages.send_email' %}">
      {% csrf_token %}
      <input type="hidden" name="parent_id" value="{{ root_id }}">
      <input type="hidden" name="recipient_email" value="{{ original_sender_email }}">
      <div class="mb-3">
        <label for="subject" class="form-label">Subject</label>
        <input type="text" class="form-control" id="subject" name="subject" value="Re: {{ root_subject }}" required>
      </div>
      <div class="mb-3">
        <label for="body" class="form-label">Message</label>
        <textarea class="form-control" id="body" name="body" rows="6" required></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Send Reply</button>
      <a href="{% url 'messages.email_inbox' %}" class="btn btn-secondary ms-2">Back to Email Inbox</a>
    </form>

  {% else %}
    <p>Thread not found.</p>
  {% endif %}
</div>
{% endblock %}
